name: Deploy Backend to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout repository
        uses: actions/checkout@v3

      - name: üîê Write SSH private key
        run: |
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem
          # V√©rifier le format de la cl√©
          echo "Format de la cl√©:"
          head -1 key.pem
          # V√©rifier que la cl√© est valide
          ssh-keygen -l -f key.pem || echo "Erreur de format de cl√© d√©tect√©e"

      - name: üöÄ Deploy and run app on VPS
        run: |
          ssh -i key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            echo "[1/6] üì¶ Cloner le projet ou mettre √† jour..."
            mkdir -p ~/collection_audios && cd ~/collection_audios
            if [ ! -d ".git" ]; then
              # Utilisez HTTPS au lieu de SSH pour le clone initial
              git clone https://github.com/AInelo/tts-medical-management.git .
            else
              git pull
            fi

            echo "[2/6] üê≥ Construire l'image Docker..."
            cd api
            docker build -t collection_audios_backend .

            echo "[3/6] üßº Nettoyage ancien conteneur..."
            docker stop collection_audios_backend || true
            docker rm collection_audios_backend || true

            echo "[4/6] üöÄ Lancer le conteneur..."
            docker run -d \
              --name collection_audios_backend \
              -p 3000:3000 \
              --restart unless-stopped \
              collection_audios_backend

            echo "[5/6] üîß Configurer NGINX..."
            sudo cp ./urmaphalab/collection.urmapha.com /etc/nginx/sites-available/collection.urmapha.com
            sudo ln -sf /etc/nginx/sites-available/collection.urmapha.com /etc/nginx/sites-enabled/collection.urmapha.com
            sudo nginx -t && sudo systemctl reload nginx

            echo "[6/6] üîê Installer SSL avec Certbot..."
            sudo apt update
            sudo apt install -y certbot python3-certbot-nginx
            sudo certbot --nginx --non-interactive --agree-tos --email your@email.com -d collection.urmaphalab.com

            echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
          EOF