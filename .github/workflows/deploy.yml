name: Deploy Backend to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Write SSH private key
        run: |
          echo "${{ secrets.VPS_URMAPHA_PRIVATE_SSH }}" > key.pem
          chmod 600 key.pem
      
      - name: ğŸš€ Deploy and run app on VPS
        run: |
          ssh -i key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            'set -e
            echo "[1/6] ğŸ“¦ Cloner le projet ou mettre Ã  jour..."
            mkdir -p ~/collection_audios && cd ~/collection_audios
            if [ ! -d ".git" ]; then
              git clone https://github.com/AInelo/tts-medical-management.git .
            else
              git pull
            fi

            echo "[2/6] ğŸ³ Construire l\'image Docker..."
            cd api
            docker build -t collection_audios_backend .

            echo "[3/6] ğŸ§¼ Nettoyage ancien conteneur..."
            docker stop collection_audios_backend || true
            docker rm collection_audios_backend || true

            echo "[4/6] ğŸš€ Lancer le conteneur..."
            docker run -d \
              --name collection_audios_backend \
              -p 3000:3000 \
              --restart unless-stopped \
              collection_audios_backend

            echo "[5/6] ğŸ”§ Configurer NGINX..."
            sudo cp ./urmaphalab/collection.urmapha.com /etc/nginx/sites-available/collection.urmapha.com
            sudo ln -sf /etc/nginx/sites-available/collection.urmapha.com /etc/nginx/sites-enabled/collection.urmapha.com
            sudo nginx -t && sudo systemctl reload nginx

            echo "[6/6] ğŸ” Installer SSL avec Certbot..."
            sudo apt update
            sudo apt install -y certbot python3-certbot-nginx
            sudo certbot --nginx --non-interactive --agree-tos --email your@email.com -d collection.urmaphalab.com

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"'