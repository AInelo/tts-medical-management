name: Deploy Backend to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ” Write SSH private key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem
      
      - name: ðŸ§ª Test SSH Connection
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'"

      - name: ðŸ“¦ Clone or update project
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[1/6] ðŸ“¦ Cloner le projet ou mettre Ã  jour..."
          mkdir -p ~/collection_audios && cd ~/collection_audios
          if [ ! -d ".git" ]; then
            git clone https://github.com/AInelo/tts-medical-management.git .
          else
            git pull
          fi
          EOF

      - name: ðŸ³ Build Docker image
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[2/6] ðŸ³ Construire l'image Docker..."
          cd ~/collection_audios/api
          docker build -t collection_audios_backend .
          EOF

      - name: ðŸ§¼ Clean old container
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[3/6] ðŸ§¼ Nettoyage ancien conteneur..."
          docker stop collection_audios_backend || true
          docker rm collection_audios_backend || true
          EOF

      - name: ðŸš€ Run new container
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[4/6] ðŸš€ Lancer le conteneur..."
          docker run -d \
            --name collection_audios_backend \
            -p 3000:3000 \
            --restart unless-stopped \
            collection_audios_backend
          EOF

      - name: ðŸ”§ Configure NGINX
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[5/6] ðŸ”§ Configurer NGINX..."
          sudo cp ~/collection_audios/urmaphalab/collection.urmapha.com /etc/nginx/sites-available/collection.urmapha.com
          sudo ln -sf /etc/nginx/sites-available/collection.urmapha.com /etc/nginx/sites-enabled/collection.urmapha.com
          sudo nginx -t && sudo systemctl reload nginx
          EOF

      - name: ðŸ” Setup SSL with Certbot
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "[6/6] ðŸ” Installer SSL avec Certbot..."
          sudo apt update
          sudo apt install -y certbot python3-certbot-nginx
          sudo certbot --nginx --non-interactive --agree-tos --email your@email.com -d collection.urmaphalab.com
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
          EOF